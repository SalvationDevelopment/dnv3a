<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dueling Network v3.a</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js" type="text/javascript"></script>
<script>

window.Communicator = null;

function dateToFlashFormat(d) {

	// Something like "Fri Sep 9 23:11 GMT+0200 2011".
	var dateStr = d.toDateString(); // "Fri Sep 9 2011"
	var timeStrParts = d.toTimeString().split(' '); // ["23:11:40", "GMT+0200", "(CEST)"]
	var ret = dateStr.substr(0, dateStr.lastIndexOf(' ')) + ' ';
	ret += timeStrParts[0].slice(0, -3) + ' ';
	ret += timeStrParts[1] + ' ';
	ret += d.getFullYear();
	return ret;
}

function stringToArray(str) {
	var ar = [], cur = '';
	if (str === '') return ar;
	var i = 0;
	while (i < str.length) {
		var ch = str[i++];
		if (ch === '\\') {
			if (i === str.length) return []; // silent error
			cur += str[i++];
		}
		else if (ch === ',') {
			ar.push(cur);
			cur = '';
		}
		else {
			cur += ch;
		}
	}
	ar.push(cur);
	return ar;
}

function arrayToString(ar) {
	var len = ar.length, escArray = [];
	if (typeof len !== 'number') throw 'Not an array.';
	for (var i = 0; i < len; ++i) {
		var s = ar[i];
		if (typeof s !== 'string') throw 'Not a string array';
		escArray.push(s.replace(/\\/g, '\\\\').replace(/,/g, '\\,'));
	}
	return escArray.join(',');
}

function randHex() {
	var ret = '';
	for (var i = 0; i < 32; ++i) {
		ret += Math.floor(Math.random() * 16).toString(16);
	}
	return ret;
}


var heartbeatTimer = null;
var hasHeartbeat = true;

window.messages = [];
function readSocketMessage(ar) {
	// messages.push(ar);
	var ev = ar[0];
	if (ev === 'Offline users' || ev === 'Online users') return; // Quite annoying.
	console.log('Read: ', ar);
}

function socketError(e) {
	console.error('Socket error: ', e);
	disconnected();
}

function disconnected() {
	if (heartbeatTimer !== null) clearInterval(heartbeatTimer);
	heartbeatTimer = null;
	console.log("DC");
}

function openConnectPage(user, token) {
	$('#loadingpage').hide();
	var page = $('#connectpage');
	page.show();
	connect = function() {
		page.hide();
		initConnection(user, token);
	};
}

function initConnection(user, token) {
	function startConnection() {
		Communicator.send(['Connect6', user, token, randHex()]);
		heartbeatTimer = setInterval(function() {
			if (hasHeartbeat) {
				Communicator.send(['Heartbeat']);
				hasHeartbeat = false;
			}
			else {
				disconnected();
			}
		}, 30000);
		// setTimeout(function() { Communicator.send(['Heartbeat']); }, 1200);
	}
	function socketStatus(st) {
		if (st === 'connected') {
			startConnection();
		}
		else {
			socketError(st);
		}
	}
	Communicator.open(readSocketMessage, socketStatus);
}

function init() {
	// TODO: Get these through a userscript.
	var user = "simonlindholm";
	var token = "6dd2c164d0fc501d3fc869a0d100fe8b";

	openConnectPage(user, token);
}

$(function() {
	$("#loadingpage").show();
	window.communicatorInitialized = function() {
		var swf = $('#swf_communicator')[0];
		var resp = null, statusHandler = null;
		window.Communicator = {
			open: function(respCb, statusCb) {
				resp = respCb;
				statusHandler = statusCb;
				swf.open();
			},
			send: function(ar) {
				swf.sendMessage(arrayToString(ar));
			},
			close: function() {
				swf.close();
			}
		};
		window.communicatorResponse = function(str) {
			window.messages.push(str);
			resp(stringToArray(str));
		};
		window.communicatorResponseStatus = function(st) {
			statusHandler(st);
		};
		init();
	};
	function flashLoaded(e) {
		if (!e.success) {
			// Flash error blah.
			alert('Flash failed to load.');
		}
	}

	var flashvars = {};
	var params = {allowscriptaccess: 'always'};
	var attributes = {};
	swfobject.embedSWF("communicator.swf", "swf_communicator", "0", "0", "10.0.0", false, flashvars, params, attributes, flashLoaded);
});
</script>
</head>
<body>
<noscript>
	This page relies on JavaScript, please enable it.
</noscript>
<div id="loadingpage" hidden>
	<p>Loading...</p>
</div>
<div id="swf_communicator" hidden></div>
<div id="connectpage" hidden>
	<input type="button" value="Connect!" onclick="connect();">
</div>
</body>
</html>
